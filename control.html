<!DOCTYPE html>
<html>
<head>
    <title>Control ESP32</title>
</head>
<body>
    <h1>Enviar Mensaje a ESP32</h1>
    
    <input type="text" id="mensaje" placeholder="Escribe tu mensaje">
    <button onclick="enviarMensaje()">Enviar</button>
    
    <div id="log" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script>
        let client = null;
        
        function conectarMQTT() {
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "web_" + Math.random());
            
            client.connect({
                onSuccess: function() {
                    agregarLog("Conectado al broker");
                },
                useSSL: true
            });
        }
        
        function enviarMensaje() {
            const mensaje = document.getElementById('mensaje').value;
            if (!mensaje) return;
            
            if (!client || !client.isConnected()) {
                agregarLog("No conectado. Conectando...");
                conectarMQTT();
                setTimeout(() => enviarMensaje(), 1000);
                return;
            }
            
            const topic = "esp32/mensajes";
            const mqttMessage = new Paho.MQTT.Message(mensaje);
            mqttMessage.destinationName = topic;
            client.send(mqttMessage);
            
            agregarLog("Enviado: " + mensaje);
            document.getElementById('mensaje').value = "";
        }
        
        function agregarLog(texto) {
            const log = document.getElementById('log');
            const tiempo = new Date().toLocaleTimeString();
            log.innerHTML += `[${tiempo}] ${texto}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // Conectar autom√°ticamente al cargar
        window.onload = conectarMQTT;
    </script>
</body>
</html>
